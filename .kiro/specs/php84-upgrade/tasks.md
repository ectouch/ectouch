# 实施计划

- [ ] 1. 准备和环境配置
- [x] 1.1 更新项目配置文件





  - 修改composer.json,将PHP版本要求更新为>=8.4.0
  - 更新依赖包到支持PHP 8.4的版本
  - 运行composer update验证依赖兼容性
  - _需求: 1.1, 1.2_

- [ ] 1.2 更新文档和说明
  - 修改README.md,更新PHP版本要求为8.4+
  - 更新安装说明中的环境要求
  - 添加PHP 8.4升级说明
  - _需求: 1.3_

- [ ] 1.3 创建代码备份
  - 创建完整的代码备份
  - 导出当前数据库结构
  - 记录当前系统版本信息
  - _需求: 所有_

- [ ] 2. 移除已弃用的PHP语法
- [ ] 2.1 替换字符串花括号访问语法
  - 搜索所有使用`$str{$index}`的代码
  - 替换为`$str[$index]`方括号语法
  - 特别关注include/classes/mysql.php和include/libraries/EcsMysql.class.php
  - 处理vendor目录中的第三方库(如果需要)
  - _需求: 2.1_

- [ ]* 2.2 编写属性测试验证字符串访问语法
  - **属性 1: 字符串访问语法一致性**
  - **验证: 需求 2.1**

- [ ] 2.3 移除get_magic_quotes_gpc()调用
  - 搜索所有get_magic_quotes_gpc()使用
  - 移除相关的条件判断
  - 简化数据过滤逻辑
  - _需求: 2.5_

- [ ] 2.4 移除PHP版本检查代码
  - 搜索所有PHP_VERSION比较
  - 移除PHP 5.x和7.x的条件分支
  - 移除function_exists等兼容性检查
  - 简化microtime()调用
  - _需求: 8.1, 8.3, 8.4, 8.5_

- [ ]* 2.5 编写属性测试验证版本检查移除
  - **属性 5: 版本检查移除完整性**
  - **验证: 需求 8.1**

- [ ] 2.6 移除MySQL 4.x版本兼容代码
  - 搜索MySQL版本检查
  - 移除对MySQL 4.x的特殊处理
  - 简化SQL模式设置
  - _需求: 4.5, 8.2_

- [ ] 3. 创建异常类层次结构
- [ ] 3.1 实现基础异常类
  - 创建include/classes/ECTouchException.php
  - 实现ECTouchException基类,支持上下文信息
  - 添加getContext()方法
  - _需求: 5.1, 5.5_

- [ ] 3.2 实现专用异常类
  - 创建DatabaseException类,包含SQL和错误信息
  - 创建FileException类,包含文件路径信息
  - 创建ValidationException类,包含验证错误详情
  - 创建ConfigException类,包含配置项信息
  - _需求: 5.2, 5.3, 5.4_

- [ ]* 3.3 编写属性测试验证异常处理
  - **属性 3: 异常处理一致性**
  - **验证: 需求 5.1**

- [ ] 3.4 实现错误日志系统
  - 创建ErrorLogger类
  - 实现异常日志记录功能
  - 配置日志文件路径和格式
  - _需求: 5.5_

- [ ] 4. 重构数据库类(mysql.php)
- [ ] 4.1 添加类型声明和属性
  - 添加declare(strict_types=1)
  - 为所有属性添加类型声明
  - 使用构造器属性提升重写__construct()
  - _需求: 3.1, 3.4, 3.5_

- [ ]* 4.2 编写属性测试验证类型声明
  - **属性 2: 类型声明完整性**
  - **验证: 需求 3.1, 3.2**

- [ ]* 4.3 编写属性测试验证构造器属性提升
  - **属性 6: 构造器属性提升正确性**
  - **验证: 需求 3.5**

- [ ] 4.4 重构connect()方法
  - 添加参数和返回类型声明
  - 移除版本检查代码
  - 使用异常替代错误输出
  - 简化字符集设置逻辑
  - _需求: 3.1, 3.2, 4.2, 4.5, 5.1_

- [ ] 4.5 重构query()方法
  - 添加类型声明(返回mysqli_result|bool)
  - 使用异常处理错误
  - 移除版本相关的条件判断
  - 优化日志记录逻辑
  - _需求: 3.1, 3.2, 4.4, 5.2_

- [ ] 4.6 重构数据获取方法
  - 为getOne()添加类型声明(返回mixed)
  - 为getAll()添加类型声明(返回array|false)
  - 为getRow()添加类型声明(返回array|false)
  - 为getCol()添加类型声明(返回array|false)
  - _需求: 3.2, 3.3, 4.4_

- [ ] 4.7 重构辅助方法
  - 为escape_string()添加类型声明
  - 为affected_rows()添加类型声明(返回int)
  - 为insert_id()添加类型声明(返回int)
  - 为close()添加类型声明(返回bool)
  - _需求: 3.1, 3.2_

- [ ]* 4.8 编写属性测试验证数据库安全性
  - **属性 4: 数据库查询安全性**
  - **验证: 需求 4.1**

- [ ] 5. 重构数据库类(EcsMysql.class.php)
- [ ] 5.1 应用与mysql.php相同的重构
  - 添加declare(strict_types=1)
  - 添加类型声明
  - 使用构造器属性提升
  - 使用异常处理
  - _需求: 3.1, 3.2, 3.4, 3.5, 5.1, 5.2_

- [ ] 5.2 移除EC_CHARSET相关的旧逻辑
  - 简化字符集处理
  - 统一使用utf8mb4
  - _需求: 4.2_

- [ ] 6. 重构辅助函数(function.php)
- [ ] 6.1 更新字符串处理函数
  - 为msubstr()添加类型声明
  - 使用match表达式替代数组查找
  - 为byte_format()添加类型声明
  - _需求: 3.1, 3.2, 6.1_

- [ ] 6.2 更新IP地址函数
  - 为get_client_ip()添加类型声明
  - 使用null合并运算符简化逻辑
  - _需求: 3.1, 3.2, 6.2_

- [ ]* 6.3 编写属性测试验证null合并运算符
  - **属性 7: Null合并运算符使用**
  - **验证: 需求 6.2**

- [ ] 6.3 更新加密解密函数
  - 为ec_encode()添加类型声明
  - 为ec_decode()添加类型声明
  - 优化字符串访问语法
  - _需求: 2.1, 3.1, 3.2_

- [ ] 6.4 更新文件操作函数
  - 为copy_dir()添加类型声明
  - 为del_dir()添加类型声明
  - 为get_extension()添加类型声明
  - 使用异常处理文件错误
  - _需求: 3.1, 3.2, 5.3_

- [ ] 6.5 更新URL和路由函数
  - 为url()和U()添加类型声明
  - 为parse_name()添加类型声明
  - 为is_ssl()添加类型声明(返回bool)
  - _需求: 3.1, 3.2_

- [ ] 6.6 更新配置函数
  - 为C()添加类型声明
  - 使用null合并运算符
  - 为load_file()添加类型声明
  - _需求: 3.1, 3.2, 6.2_

- [ ] 7. 重构辅助函数(base_helper.php)
- [ ] 7.1 更新字符串函数
  - 为sub_str()添加类型声明
  - 为str_len()添加类型声明(返回int)
  - 为mysql_like_quote()添加类型声明
  - 使用str_contains()替代strpos()
  - _需求: 3.1, 3.2, 6.3_

- [ ]* 7.2 编写属性测试验证现代字符串函数
  - **属性 8: 现代字符串函数使用**
  - **验证: 需求 6.3**

- [ ] 7.2 更新IP和网络函数
  - 为real_ip()添加类型声明
  - 为real_server_ip()添加类型声明
  - 使用null合并运算符
  - _需求: 3.1, 3.2, 6.2_

- [ ] 7.3 更新文件函数
  - 为file_mode_info()添加类型声明
  - 为make_dir()添加类型声明(返回bool)
  - 为move_upload_file()添加类型声明(返回bool)
  - 使用异常处理文件错误
  - _需求: 3.1, 3.2, 5.3_

- [ ] 7.4 更新邮件函数
  - 为send_mail()添加类型声明(返回bool)
  - 使用异常处理SMTP错误
  - _需求: 3.1, 3.2, 5.1_

- [ ] 7.5 更新编码转换函数
  - 为ecs_iconv()添加类型声明
  - 为json_str_iconv()添加类型声明
  - 为to_utf8_iconv()添加类型声明
  - _需求: 3.1, 3.2_

- [ ] 8. 更新安装程序
- [ ] 8.1 更新install/index.php
  - 添加PHP 8.4版本检查
  - 更新环境检测逻辑
  - 移除旧版本兼容代码
  - 更新错误消息
  - _需求: 7.1, 7.3, 7.4_

- [ ] 8.2 更新install/main.php
  - 验证mysqli扩展
  - 检查必需的PHP特性
  - 更新安装向导界面
  - _需求: 7.2, 7.5_

- [ ] 9. 更新引导系统
- [ ] 9.1 更新include/bootstrap.php
  - 添加declare(strict_types=1)
  - 更新错误处理配置
  - 移除版本检查
  - 优化自动加载器
  - _需求: 8.4, 9.1, 9.2_

- [ ] 9.2 优化自动加载机制
  - 为autoload()添加类型声明
  - 优化类文件查找逻辑
  - 确保PSR-4兼容性
  - _需求: 9.1, 9.2, 9.3, 9.4_

- [ ] 10. 创建配置类
- [ ] 10.1 实现DatabaseConfig类
  - 创建readonly类
  - 使用构造器属性提升
  - 添加验证逻辑
  - _需求: 3.4, 3.5, 6.5_

- [ ] 10.2 实现AppConfig类
  - 创建readonly类
  - 组合DatabaseConfig
  - 添加配置加载方法
  - _需求: 3.4, 3.5, 6.5_

- [ ] 11. 更新控制器基类
- [ ] 11.1 为控制器添加类型声明
  - 检查所有控制器类
  - 添加方法类型声明
  - 使用异常处理错误
  - _需求: 3.1, 3.2, 5.1_

- [ ] 12. 更新模型基类
- [ ] 12.1 为模型添加类型声明
  - 检查所有模型类
  - 添加方法类型声明
  - 优化数据库操作
  - _需求: 3.1, 3.2, 4.1_

- [ ] 13. 处理第三方库
- [ ] 13.1 检查vendor目录
  - 识别不兼容的库
  - 更新到PHP 8.4兼容版本
  - 记录无法更新的库
  - _需求: 1.1_

- [ ] 13.2 处理PHPExcel等旧库
  - 考虑替换为PhpSpreadsheet
  - 或修复字符串访问语法
  - 测试功能完整性
  - _需求: 2.1_

- [ ] 14. 测试和验证
- [ ] 14.1 运行语法检查
  - 使用php -l检查所有PHP文件
  - 修复语法错误
  - 确保无弃用警告
  - _需求: 10.5_

- [ ]* 14.2 运行单元测试
  - 测试数据库类
  - 测试辅助函数
  - 测试异常处理
  - _需求: 10.1, 10.2, 10.3, 10.4_

- [ ]* 14.3 运行属性基测试
  - 执行所有属性测试
  - 验证正确性属性
  - 记录测试结果
  - _需求: 所有_

- [ ]* 14.4 执行集成测试
  - 测试前台功能
  - 测试后台功能
  - 测试API接口
  - _需求: 10.2, 10.3, 10.4_

- [ ]* 14.5 性能基准测试
  - 对比升级前后性能
  - 测试数据库查询速度
  - 测试页面加载时间
  - 优化性能瓶颈
  - _需求: 10.4_

- [ ] 15. 文档和部署
- [ ] 15.1 更新API文档
  - 记录新的类型签名
  - 更新异常说明
  - 添加迁移指南
  - _需求: 所有_

- [ ] 15.2 创建升级指南
  - 编写升级步骤
  - 记录注意事项
  - 提供回滚方案
  - _需求: 所有_

- [ ] 15.3 准备发布
  - 更新版本号
  - 生成变更日志
  - 打包发布文件
  - _需求: 所有_

- [ ] 16. 最终验证
- [ ] 16.1 在PHP 8.4环境中完整测试
  - 安装全新系统
  - 测试所有核心功能
  - 验证无错误和警告
  - _需求: 10.1, 10.2, 10.3, 10.4, 10.5_

- [ ] 16.2 确保所有测试通过,询问用户是否有问题
  - 确保所有测试通过,询问用户是否有问题
